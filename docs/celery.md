–û—Ç–ª–∏—á–Ω—ã–π —à–∞–≥ ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è **Celery** –≤ –ø—Ä–æ–µ–∫—Ç –ø–æ–∑–≤–æ–ª–∏—Ç —Ç–µ–±–µ –∑–∞–ø—É—Å–∫–∞—Ç—å **—Ñ–æ–Ω–æ–≤—É—é –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á**, –Ω–∞–ø—Ä–∏–º–µ—Ä, **–ø–µ—Ä–µ–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ –≤–Ω–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞ FastAPI**, –Ω–µ –±–ª–æ–∫–∏—Ä—É—è API –ø—Ä–∏ —Ç—è–∂—ë–ª—ã—Ö –∏–ª–∏ –¥–æ–ª–≥–∏—Ö –ø–µ—Ä–µ–≤–æ–¥–∞—Ö. –ù–∏–∂–µ –ø–æ–¥—Ä–æ–±–Ω—ã–π –ø–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è:

---

## üîß –ß—Ç–æ —Ç–∞–∫–æ–µ Celery –∏ –∑–∞—á–µ–º –æ–Ω –Ω—É–∂–µ–Ω?

**Celery** ‚Äî —ç—Ç–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–∞—è –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö), –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∑–≤–æ–ª—è–µ—Ç:
- –∑–∞–ø—É—Å–∫–∞—Ç—å –∑–∞–¥–∞—á–∏ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ;
- –≤—ã–ø–æ–ª–Ω—è—Ç—å –∏—Ö –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (–Ω–∞ —Ä–∞–±–æ—á–∏—Ö –≤–æ—Ä–∫–µ—Ä–∞—Ö);
- –ø–æ–≤—Ç–æ—Ä–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ—Å—É—Ä—Å–æ—ë–º–∫–∏–µ –∑–∞–¥–∞—á–∏ (–ø–µ—Ä–µ–≤–æ–¥, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è);
- –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –ø—Ä–∏ –±–æ–ª—å—à–æ–º –ø–æ—Ç–æ–∫–µ –∑–∞–ø—Ä–æ—Å–æ–≤.

> –í —Ç–≤–æ—ë–º —Å–ª—É—á–∞–µ: **–ø–µ—Ä–µ–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞** ‚Äî –æ—Ç–ª–∏—á–Ω–∞—è –∫–∞–Ω–¥–∏–¥–∞—Ç—É—Ä–∞ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É –≤ –æ—á–µ—Ä–µ–¥—å.

---

## ‚úÖ –ß—Ç–æ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è:

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç        | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                      |
|------------------|-------------------------------------------------|
| **Celery**       | –°–∞–º–∞ –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á                              |
| **Redis**        | –ë—Ä–æ–∫–µ—Ä (–æ—á–µ—Ä–µ–¥—å —Å–æ–æ–±—â–µ–Ω–∏–π –º–µ–∂–¥—É API –∏ –≤–æ—Ä–∫–µ—Ä–æ–º) |
| **FastAPI**      | –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–¥–∞—á–∏ Celery                        |
| **Worker**       | –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–¥–∞—á–∏ (–≤—ã–ø–æ–ª–Ω—è–µ—Ç `translate`)     |

---

## üß± –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è Celery

```
app/
‚îú‚îÄ‚îÄ service/
‚îÇ   ‚îî‚îÄ‚îÄ tasks.py          # <-- Celery –∑–∞–¥–∞—á–∏ (–ø–µ—Ä–µ–≤–æ–¥)
‚îú‚îÄ‚îÄ worker.py             # <-- –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è Celery worker
‚îú‚îÄ‚îÄ routers/
‚îÇ   ‚îî‚îÄ‚îÄ translate_router.py  # <-- API —Ç–µ–ø–µ—Ä—å –≤—ã–∑—ã–≤–∞–µ—Ç celery.delay()
docker/
‚îú‚îÄ‚îÄ docker-compose.yml    # <-- Redis, worker, app
```

---

## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
pip install celery[redis] redis
```

---

## üîå –®–∞–≥ 1: –ö–æ–Ω—Ñ–∏–≥ –∏ –∑–∞–ø—É—Å–∫ Celery

### üìù `app/service/tasks.py`

```python
from celery import Celery
from app.models.translate_handler import TranslateHandler
from app.config import settings

# –°–æ–∑–¥–∞—ë–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Celery
celery_app = Celery(
    "translation_tasks",
    broker="redis://localhost:6379/0",  # –º–æ–∂–Ω–æ –≤–∑—è—Ç—å –∏–∑ settings.REDIS_URL
    backend="redis://localhost:6379/0"
)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–æ–¥–µ–ª—å 1 —Ä–∞–∑ –Ω–∞ worker
translate_handler = TranslateHandler(
    model_name=settings.MODEL_NAME,
    cache_dir=settings.CACHE_DIR,
    device=settings.DEVICE
)

@celery_app.task(name="tasks.translate_batch")
def translate_batch_task(texts, source_lang, target_langs):
    """
    –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞.
    """
    return translate_handler.handle_translate_request(texts, source_lang, target_langs)
```

---

## üöÄ –®–∞–≥ 2: –°–æ–∑–¥–∞—ë–º worker

### üìù `worker.py`

```python
from app.service.tasks import celery_app

# –≠—Ç–æ –≤—Å—ë, —á—Ç–æ –Ω—É–∂–Ω–æ ‚Äî celery –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–≥—Ä—É–∑–∏—Ç –∑–∞–¥–∞—á–∏
```

---

## ‚öôÔ∏è –®–∞–≥ 3: –í—ã–∑—ã–≤–∞–µ–º –∑–∞–¥–∞—á—É –∏–∑ FastAPI

### üìù –í `translate_router.py`

```python
from app.service.tasks import translate_batch_task

@router.post("/api/translate_async")
async def translate_async(request: TranslateRequest):
    """
    –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ (–≤ –æ—á–µ—Ä–µ–¥—å Celery).
    """
    task = translate_batch_task.delay(
        request.texts,
        request.source_lang,
        request.target_langs
    )
    return {"task_id": task.id}
```

---

## üì• –®–∞–≥ 4: –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

```python
from app.service.tasks import celery_app

@router.get("/api/result/{task_id}")
async def get_result(task_id: str):
    """
    –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏.
    """
    result = celery_app.AsyncResult(task_id)
    if result.state == "PENDING":
        return {"status": "pending"}
    elif result.state == "SUCCESS":
        return {"status": "completed", "result": result.result}
    elif result.state == "FAILURE":
        return {"status": "failed", "error": str(result.result)}
    return {"status": result.state}
```

---

## üê≥ –®–∞–≥ 5: `docker-compose.yml` —Å Redis + worker

```yaml
version: "3.9"
services:
  app:
    build: .
    ports:
      - "8000:8000"
    depends_on:
      - redis

  redis:
    image: redis:alpine
    ports:
      - "6379:6379"

  worker:
    build: .
    command: celery -A app.service.tasks worker --loglevel=info
    depends_on:
      - redis
```

---

## üß™ –ü—Ä–∏–º–µ—Ä –∑–∞–ø—É—Å–∫–∞:

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å redis –ª–æ–∫–∞–ª—å–Ω–æ (–µ—Å–ª–∏ –±–µ–∑ Docker)
docker run -d -p 6379:6379 redis

# –ó–∞–ø—É—Å—Ç–∏—Ç—å FastAPI
uvicorn app.main:app --reload

# –ó–∞–ø—É—Å—Ç–∏—Ç—å worker –æ—Ç–¥–µ–ª—å–Ω–æ:
celery -A app.service.tasks worker --loglevel=info
```

---

## üí° –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?

1. –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST-–∑–∞–ø—Ä–æ—Å `/api/translate_async`.
2. FastAPI –∫–ª–∞–¥—ë—Ç –∑–∞–¥–∞—á—É –≤ Redis.
3. Celery worker –±–µ—Ä—ë—Ç –∑–∞–¥–∞—á—É, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –µ—ë (–ø–µ—Ä–µ–≤–æ–¥).
4. –ö–ª–∏–µ–Ω—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç `/api/result/{task_id}`.
5. –ö–∞–∫ —Ç–æ–ª—å–∫–æ –∑–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ‚Äî –ø–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

---

## üìö –•–æ—á–µ—à—å:
- –ø—Ä–∏–º–µ—Ä —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º –∑–∞–¥–∞—á–∏ (—á–µ—Ä–µ–∑ `meta`);
- –ø–æ–¥–¥–µ—Ä–∂–∫—É –æ—á–µ—Ä–µ–¥–µ–π —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏;
- –∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –∏ retries?

–°–∫–∞–∂–∏ ‚Äî –¥–æ–ø–∏—à—É –Ω—É–∂–Ω–æ–µ!